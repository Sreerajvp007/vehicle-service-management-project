<form id="jobcardForm" enctype="multipart/form-data" class="p-4 shadow rounded bg-light">
  <h3 class="mb-4 text-primary">Edit Job Card: <%= jobcard.jobcardNumber %></h3>

  <!-- Hidden field for job card ID -->
  <input type="hidden" name="id" value="<%= jobcard._id %>">

  <!-- Client Details -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Client Details</legend>
    <div class="mb-3">
      <label>Client Name *</label>
      <input type="text" name="clientname" class="form-control" value="<%= jobcard.clientname %>" required />
    </div>
    <div class="row">
      <div class="col-md-4 mb-3">
        <label>Email</label>
        <input type="email" name="email" class="form-control" value="<%= jobcard.email %>" />
      </div>
      <div class="col-md-4 mb-3">
        <label>Phone</label>
        <input type="text" name="phone" class="form-control" value="<%= jobcard.phone %>" />
      </div>
      <div class="col-md-4 mb-3">
        <label>City</label>
        <input type="text" name="city" class="form-control" value="<%= jobcard.city || '' %>" />
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Post Code</label>
        <input type="text" name="postcode" class="form-control" value="<%= jobcard.postcode || '' %>" />
      </div>
      <div class="col-md-6 mb-3">
        <label>State</label>
        <input type="text" name="state" class="form-control" value="<%= jobcard.state || '' %>" />
      </div>
    </div>
  </fieldset>

  <!-- Vehicle Details -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Vehicle Details</legend>

    <!-- Select Vehicle Dropdown -->
    <div class="mb-3">
      <label>Select Vehicle *</label>
      <select name="vehicle" class="form-control" required>
        <% vehicleList.forEach(v => { %>
          <option value="<%= v._id %>" <%= jobcard.vehicle && jobcard.vehicle._id.toString() === v._id.toString() ? 'selected' : '' %>>
            <%= v.brand %> - <%= v.model %> (<%= v.type %>)
          </option>
        <% }) %>
      </select>
    </div>

    <!-- Additional fields -->
    <div class="row">
      <div class="col-md-4 mb-3">
        <label>Registration Number</label>
        <input type="text" name="registrationNumber" class="form-control" value="<%= jobcard.registrationNumber || '' %>" />
      </div>
      <div class="col-md-4 mb-3">
        <label>Year</label>
        <input type="number" name="year" class="form-control" value="<%= jobcard.year || '' %>" />
      </div>
      <div class="col-md-4 mb-3">
        <label>Mileage</label>
        <input type="text" name="mileage" class="form-control" value="<%= jobcard.mileage || '' %>" />
      </div>
    </div>
  </fieldset>

  <!-- Service Details -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Service Details</legend>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Date Time In *</label>
        <input type="datetime-local" name="dateTimeIn" class="form-control" 
               value="<%= jobcard.dateTimeIn ? new Date(jobcard.dateTimeIn).toISOString().slice(0, 16) : '' %>" required />
      </div>
      <div class="col-md-6 mb-3">
        <label>Date Time Out</label>
        <input type="datetime-local" name="dateTimeOut" class="form-control" 
               value="<%= jobcard.dateTimeOut ? new Date(jobcard.dateTimeOut).toISOString().slice(0, 16) : '' %>" />
      </div>
    </div>
    <div class="mb-3">
      <label>Service Type</label>
      <select name="serviceType" class="form-control">
        <option value="Regular" <%= jobcard.serviceType === 'Regular' ? 'selected' : '' %>>Regular</option>
        <option value="Accident Repair" <%= jobcard.serviceType === 'Accident Repair' ? 'selected' : '' %>>Accident Repair</option>
        <option value="Maintenance" <%= jobcard.serviceType === 'Maintenance' ? 'selected' : '' %>>Maintenance</option>
      </select>
    </div>
    <div class="mb-3">
      <label>Reported Defect</label>
      <textarea name="reportedDefect" class="form-control"><%= jobcard.reportedDefect || '' %></textarea>
    </div>
  </fieldset>

  <!-- Damaged Parts -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Damaged Parts</legend>
    <input type="file" name="damagedParts" class="form-control" multiple />
    <% if (jobcard.damagedParts && jobcard.damagedParts.length > 0) { %>
      <div class="mt-2">
        <p class="mb-1">Existing damaged part images:</p>
        <% jobcard.damagedParts.forEach(part => { %>
          <span class="badge bg-secondary me-1">Image</span>
        <% }) %>
      </div>
    <% } %>
  </fieldset>

  <!-- Technician Assignment -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Technician</legend>
    <div class="mb-3">
      <label>Assign Technician</label>
      <select name="assignedTechnician" class="form-control">
        <option value="">Not Assigned</option>
        <% technicianList.forEach(t => { %>
          <option value="<%= t._id %>" <%= jobcard.assignedTechnician && jobcard.assignedTechnician._id.toString() === t._id.toString() ? 'selected' : '' %>>
            <%= t.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="mb-3">
      <label>Special Instructions</label>
      <textarea name="specialInstructions" class="form-control"><%= jobcard.specialInstructions || '' %></textarea>
    </div>
    <div class="mb-3">
      <label>Technician Remarks</label>
      <textarea name="technicianRemarks" class="form-control"><%= jobcard.technicianRemarks || '' %></textarea>
    </div>
  </fieldset>

  <!-- Parts Used -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Parts Used</legend>
    <div id="parts-container">
      <% if (jobcard.parts && jobcard.parts.length > 0) { %>
        <% jobcard.parts.forEach((part, index) => { %>
          <div class="row mb-2">
            <div class="col-md-2"><input type="text" name="parts[<%= index %>][partNo]" placeholder="Part No" class="form-control" value="<%= part.partNo || '' %>" /></div>
            <div class="col-md-3"><input type="text" name="parts[<%= index %>][partDescription]" placeholder="Description" class="form-control" value="<%= part.partDescription || '' %>" /></div>
            <div class="col-md-1"><input type="number" name="parts[<%= index %>][qty]" placeholder="Qty" class="form-control" value="<%= part.qty || '' %>" /></div>
            <div class="col-md-2"><input type="number" name="parts[<%= index %>][unitPrice]" placeholder="Unit Price" class="form-control" value="<%= part.unitPrice || '' %>" /></div>
            <div class="col-md-2"><input type="number" name="parts[<%= index %>][labour]" placeholder="Labour" class="form-control" value="<%= part.labour || '' %>" /></div>
            <div class="col-md-2"><input type="number" name="parts[<%= index %>][lineTotal]" placeholder="Line Total" class="form-control" value="<%= part.lineTotal || '' %>" /></div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="row mb-2">
          <div class="col-md-2"><input type="text" name="parts[0][partNo]" placeholder="Part No" class="form-control" /></div>
          <div class="col-md-3"><input type="text" name="parts[0][partDescription]" placeholder="Description" class="form-control" /></div>
          <div class="col-md-1"><input type="number" name="parts[0][qty]" placeholder="Qty" class="form-control" /></div>
          <div class="col-md-2"><input type="number" name="parts[0][unitPrice]" placeholder="Unit Price" class="form-control" /></div>
          <div class="col-md-2"><input type="number" name="parts[0][labour]" placeholder="Labour" class="form-control" /></div>
          <div class="col-md-2"><input type="number" name="parts[0][lineTotal]" placeholder="Line Total" class="form-control" /></div>
        </div>
      <% } %>
    </div>
    <button type="button" class="btn btn-secondary mb-3" onclick="addPart()">+ Add Part</button>
  </fieldset>

  <!-- Repair Status -->
  <fieldset class="border p-3 mb-4">
    <legend class="w-auto px-2">Repair Status</legend>
    <select name="repairStatus" class="form-control">
      <option value="open" <%= jobcard.repairStatus === 'open' ? 'selected' : '' %>>Open</option>
      <option value="in-progress" <%= jobcard.repairStatus === 'in-progress' ? 'selected' : '' %>>In Progress</option>
      <option value="on-hold" <%= jobcard.repairStatus === 'on-hold' ? 'selected' : '' %>>On Hold</option>
      <option value="completed" <%= jobcard.repairStatus === 'completed' ? 'selected' : '' %>>Completed</option>
      <option value="delivered" <%= jobcard.repairStatus === 'delivered' ? 'selected' : '' %>>Delivered</option>
    </select>
  </fieldset>

  <button type="submit" class="btn btn-primary">Update Job Card</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Add Part Dynamic Rows
  let partIndex = 1;
  function addPart() {
    const container = document.getElementById('parts-container');
    const row = document.createElement('div');
    row.classList.add('row','mb-2');
    row.innerHTML = `
      <div class="col-md-2"><input type="text" name="parts[${partIndex}][partNo]" placeholder="Part No" class="form-control" /></div>
      <div class="col-md-3"><input type="text" name="parts[${partIndex}][partDescription]" placeholder="Description" class="form-control" /></div>
      <div class="col-md-1"><input type="number" name="parts[${partIndex}][qty]" placeholder="Qty" class="form-control" /></div>
      <div class="col-md-2"><input type="number" name="parts[${partIndex}][unitPrice]" placeholder="Unit Price" class="form-control" /></div>
      <div class="col-md-2"><input type="number" name="parts[${partIndex}][labour]" placeholder="Labour" class="form-control" /></div>
      <div class="col-md-2"><input type="number" name="parts[${partIndex}][lineTotal]" placeholder="Line Total" class="form-control" /></div>
    `;
    container.appendChild(row);
    partIndex++;
  }

  // Form submission with SweetAlert
  document.getElementById("jobcardForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    Swal.fire({
      title: 'Updating Job Card',
      text: 'Please wait...',
      icon: 'info',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    const form = e.target;
    const formData = new FormData(form); // includes text + files
    const jobcardId = form.querySelector('input[name="id"]').value;

    try {
      const response = await fetch(`/workshopadmin/jobcard/${jobcardId}`, {
        method: "PUT",
        body: formData // ðŸ‘ˆ send raw formData (multer handles it)
      });

      const result = await response.json();

      if (response.ok) {
        Swal.fire({
          title: 'Success!',
          text: 'Job card updated successfully!',
          icon: 'success',
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.href = '/workshopadmin/jobcard';
        });
      } else {
        Swal.fire({
          title: 'Error!',
          text: result.message || 'Failed to update job card',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      }
    } catch (err) {
      console.error("Error:", err);
      Swal.fire({
        title: 'Error!',
        text: 'Something went wrong. Please try again.',
        icon: 'error',
        confirmButtonText: 'OK'
      });
    }
  });

   
 document.getElementById("logoutBtn")?.addEventListener("click", function(e) {
  e.preventDefault();
  Swal.fire({
    title: "Are you sure?",
    text: "You will be logged out.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, logout",
    cancelButtonText: "Cancel"
  }).then(async result => {
    if (result.isConfirmed) {
      const res = await fetch("/user/logout", { method: "POST" });
      const data = await res.json();

      if (data.success) {
        window.location.href = "/user/login";
      } else {
        Swal.fire("Error", data.message, "error");
      }
    }
  });
});

</script>